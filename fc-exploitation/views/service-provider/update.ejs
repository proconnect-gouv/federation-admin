<!DOCTYPE html>
<html lang="fr">

<head>
  <%- include('partials/head.ejs') -%>
</head>

<body>
  <%- include('partials/header.ejs') -%>
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <p class="h2">Modifier le fournisseur de service : <%= messages.values[0].title%> </p>
      </div>
      <div class="card col-12">
        <%- include('partials/global-errors-handler.ejs') -%>
        <div class="card-body">
          <form method="POST" action="<%= APP_ROOT %>/service-provider/<%= id%>?_method=PATCH" data-init="validForm" id="fs-form" name="fs-form" data-select="form" novalidate>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="name">Nom du fournisseur de service (mire) : </label>
              <div class="col-10">
                <input id="name" type="text" required class="form-control <%= locals.messages.errors && messages.errors[0].name && 'is-invalid' %>" placeholder="<%= locals.messages.values && messages.values[0].name %>" name="name" value="<%= locals.messages.values && messages.values[0].name %>" pattern="<%= VALID_INPUT_STRING_REGEX %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].name) { %>
                  <p>
                    <% messages.errors[0].name.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )
                  <% } %>
                </div>
              </div>
            </section>

            <section class="form-group row">
              <label class="col-2 col-form-label" for="redirectUri">URL de redirection de connexion : </label>
              <div class="col-10">
                <textarea id="redirectUri" class="form-control <%= locals.messages.errors && messages.errors[0].redirectUri && 'is-invalid' %>" placeholder="https://url-de-redirection.com" name="redirectUri" pattern="^(?:((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|(([A-Za-z0-9\.\+-]{6,}):(?:\/\/)?(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-_]+)|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)?)$"><%= locals.messages.values && messages.values[0].redirectUri %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].redirectUri) { %>
                  <p>
                    <% messages.errors[0].redirectUri.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL valide ( Ex: https://urlvalide.com/ )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="redirectUriLogout">URL de redirection de déconnexion : </label>
              <div class="col-10">
                <textarea id="redirectUriLogout" type="text" class="form-control <%= locals.messages.errors && messages.errors[0].redirectUriLogout && 'is-invalid' %>" name="redirectUriLogout" placeholder="https://url-de-redirection.com/deconnexion" pattern="^(?:((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|(([A-Za-z0-9\.\+-]{6,}):(?:\/\/)?(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-_]+)|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)?)$"><%= locals.messages.values && ( messages.values[0].postLogoutUri || messages.values[0].redirectUriLogout ) %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].redirectUriLogout) { %>
                  <p>
                    <% messages.errors[0].redirectUriLogout.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL valide ( Ex: https://urlvalide.com/ )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="site">Site : </label>
              <div class="col-10">
                <textarea id="site" class="form-control <%= locals.messages.errors && messages.errors[0].site && 'is-invalid' %>" placeholder="https://monsite.com" name="site" pattern="^(?:((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?))?$"><%= locals.messages.values && messages.values[0].site %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].site) { %>
                  <p>
                    <% messages.errors[0].site.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL valide ( Ex: https://site.com/ )
                  <% } %>
                </div>
              </div>
            </section>

            <% if(locals.instanceService.isFcpHigh()) { %>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="jwksUri"> Client keys url : </label>
              <div class="col-10">
                <input id="jwksUri" type="text" class="form-control <%= locals.messages.errors && messages.errors[0].jwksUri && 'is-invalid' %>" name="jwksUri" value="<%= locals.messages.values && messages.values[0].jwksUri %>" pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                <div class="invalid-feedback" placeholder="https://client-keys-url/jwks">
                  <% if (locals.messages.errors && messages.errors[0].jwksUri) { %>
                  <p>
                    <% messages.errors[0].jwksUri.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une client keys url valide au format ( Ex: https://urlvalide.fr/jwks )
                  <% } %>
                </div>
              </div>
            </section>
            <% } %>

            <section class="form-group row">
              <label class="col-2 col-form-label" for="emails">Email(s) de contact (un par ligne)</label>
              <div class="col-10">
                <textarea id="emails" class="form-control  <%= locals.messages.errors && messages.errors[0].emails && 'is-invalid' %>" placeholder="email@email.com" name="emails" pattern="^$|^([a-zA-Z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,10})$"><%= locals.messages.values && messages.values[0].emails %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].emails) { %>
                  <p>
                    <% messages.errors[0].emails.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre des emails valides ( Ex: email@email.com )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="ipAddresses">Plages d'adresses IP (une par ligne)</label>
              <div class="col-10">
                <textarea id="ipAddresses" class="form-control  <%= locals.messages.errors && messages.errors[0].ipAddresses && 'is-invalid' %>" placeholder="1.1.1.1" name="ipAddresses" pattern="<%= IP_VALIDATOR_REGEX %>"><%= locals.messages.values && ( messages.values[0].ipAddresses || messages.values[0].ipsRanges ) %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].ipAddresses) { %>
                  <p>
                    <% messages.errors[0].ipAddresses.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre des ips valides ( Ex: 1.1.1.1 )
                  <% } %>
                </div>
              </div>
            </section>

            <%- include('partials/scopes.ejs') -%>

            <%- include('partials/claims.ejs') -%>

            <section class="form-group row">
              <label class="col-2 col-form-label">Activé : </label>
              <div class="form-group col-4 d-flex align-items-end">
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input
                    <%= locals.messages.errors && messages.errors[0].active && 'is-invalid' %>" id="activated" name="active" value="true" <% if(locals.messages.values && `${messages.values[0].active}` === 'true'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="activated">oui</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input
                    <%= locals.messages.errors && messages.errors[0].active && 'is-invalid' %>" id="unactivated" name="active" value="false" <% if(locals.messages.values && `${messages.values[0].active}` === 'false'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="unactivated">non</label>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label">Accepte les employé.e.s d'organisme privé</label>
              <div class="form-group col-4 d-flex align-items-end">
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class=" custom-control-input is-consent-required <%= locals.messages.errors && messages.errors[0].type && 'is-invalid' %>" id="public" name="type" value="public" <% if(locals.messages.values && messages.values[0].type === 'public'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="public">non</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input is-consent-required <%= locals.messages.errors && messages.errors[0].type && 'is-invalid' %>" id="private" name="type" value="private" <% if(locals.messages.values && messages.values[0].type === 'private'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="private">oui</label>
                </div>
            </section>

            <div class="form-group row">
              <label class="col-2 col-form-label" for="id_token_signed_response_alg">id_token_signed_response_alg : </label>
              <div class="col-10">
                <select class="custom-select" name="id_token_signed_response_alg" required>
                  <option value="HS256" <%= messages.values && messages.values[0].id_token_signed_response_alg === "HS256" ? 'selected' : '' %>>HS256</option>
                  <option value="ES256" <%= messages.values && messages.values[0].id_token_signed_response_alg === "ES256" ? 'selected' : '' %>>ES256</option>
                  <option value="RS256" <%= messages.values && messages.values[0].id_token_signed_response_alg === "RS256" ? 'selected' : '' %>>RS256</option>
                </select>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-2 col-form-label" for="userinfo_signed_response_alg">userinfo_signed_response_alg : </label>
              <div class="col-10">
                <select class="custom-select" name="userinfo_signed_response_alg">
                  <option value="" <%= messages.values && messages.values[0].userinfo_signed_response_alg === "" ? 'selected' : '' %>>Aucun</option>
                  <option value="HS256" <%= messages.values && messages.values[0].userinfo_signed_response_alg === "HS256" ? 'selected' : '' %>>HS256</option>
                  <option value="ES256" <%= messages.values && messages.values[0].userinfo_signed_response_alg === "ES256" ? 'selected' : '' %>>ES256</option>
                  <option value="RS256" <%= messages.values && messages.values[0].userinfo_signed_response_alg === "RS256" ? 'selected' : '' %>>RS256</option>
                </select>
              </div>
            </div>

            <section class="form-group row">
              <label class="col-2 col-form-label" for="entityId">Id d'entité : </label>
              <div class="col-10 d-flex align-items-center">
                <%= locals.messages.values && messages.values[0].entityId %>
              </div>
            </section>

            <%- include('partials/resource-server.ejs') -%>

            <section class="form-group row">
              <label class="col-2 col-form-label" for="confirm-2FAuthentication">Code TOTP</label>
              <div class="col-10">
                <input id="_totp" type="text" required class="form-control <%= locals.messages.errors && messages.errors[0]._totp && 'is-invalid' %>" name="_totp">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0]._totp) { %>
                  <p>
                    <% messages.errors[0]._totp.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un code TOTP valide.
                  <% } %>
                </div>
              </div>
            </section>

            <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
            <button type="submit" class="btn btn-primary">Enregistrer les informations</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
